version: '2.1'

services:
  api:
    image: balena/jellyfish
    build:
      context: .
      dockerfile: ./apps/server/Dockerfile
      args:
        - NPM_TOKEN
    networks:
      - internal
    depends_on:
      - postgres
      - redis
      - worker_1
      - worker_2
      - balena-mdns-publisher
    environment:
      - NODE_ENV
    secrets:
      - aws_access_key_id
      - aws_s3_bucket_name
      - aws_secret_access_key
      - integration_balena_api_app_id
      - integration_balena_api_app_secret
      - integration_balena_api_private_key
      - integration_balena_api_public_key_production
      - integration_balena_api_public_key_staging
      - integration_discourse_signature_key
      - integration_discourse_token
      - integration_discourse_username
      - integration_flowdock_signature_key
      - integration_flowdock_token
      - integration_front_token
      - integration_github_app_id
      - integration_github_private_key
      - integration_github_signature_key
      - integration_github_token
      - integration_google_meet_credentials
      - integration_intercom_token
      - integration_outreach_app_id
      - integration_outreach_app_secret
      - integration_outreach_signature_key
      - integration_typeform_signature_key
      - mailgun_token
      - reset_password_secret_token
      - registry_token_auth_cert_key
      - registry_token_auth_cert_kid
    healthcheck:
      interval: 30s
      retries: 5
      test:
        - CMD
        - curl
        - --fail
        - http://localhost:80/health
      timeout: 10s
    expose:
      - 80
    ports:
      - 9229
    restart: always
  livechat:
    image: balena/jellyfish-livechat
    build:
      args:
        - NPM_TOKEN
      context: .
      dockerfile: ./apps/livechat/Dockerfile
    depends_on:
      - api
      - balena-mdns-publisher
    networks:
      - internal
    environment:
      - SENTRY_DSN_UI=0
      - NGINX_PORT=80
  postgres:
    image: balena/open-balena-db:4.1.0
    restart: always
    networks:
      - internal
  redis:
    image: balena/balena-redis:0.0.3
    command: [sh, -c, "redis-server /usr/local/etc/redis/redis.conf --save ''"]
    restart: always
    networks:
      - internal
  ui:
    image: balena/jellyfish-ui
    build:
      args:
        - NPM_TOKEN
      context: .
      dockerfile: ./apps/ui/Dockerfile
    depends_on:
      - api
      - balena-mdns-publisher
    environment:
      - SENTRY_DSN_UI=0
      - NGINX_PORT=80
      - NODE_ENV
    networks:
      - internal
  worker_1:
    image: balena/jellyfish-action-server
    build:
      context: .
      dockerfile: ./apps/action-server/Dockerfile
      args:
        - NPM_TOKEN
    depends_on:
      - postgres
      - redis
      - balena-mdns-publisher
    environment:
      - NODE_ENV
    secrets:
      - aws_access_key_id
      - aws_s3_bucket_name
      - aws_secret_access_key
      - integration_balena_api_app_id
      - integration_balena_api_app_secret
      - integration_balena_api_private_key
      - integration_balena_api_public_key_production
      - integration_balena_api_public_key_staging
      - integration_discourse_signature_key
      - integration_discourse_token
      - integration_discourse_username
      - integration_flowdock_signature_key
      - integration_flowdock_token
      - integration_front_token
      - integration_github_app_id
      - integration_github_private_key
      - integration_github_signature_key
      - integration_github_token
      - integration_google_meet_credentials
      - integration_intercom_token
      - integration_outreach_app_id
      - integration_outreach_app_secret
      - integration_outreach_signature_key
      - integration_typeform_signature_key
      - mailgun_token
      - reset_password_secret_token
    restart: always
    networks:
      - internal
    ports:
      - 9231:9229
  worker_2:
    image: balena/jellyfish-action-server
    build:
      context: .
      dockerfile: ./apps/action-server/Dockerfile
      args:
        - NPM_TOKEN
    depends_on:
      - postgres
      - redis
      - balena-mdns-publisher
    environment:
      - NODE_ENV
    secrets:
      - aws_access_key_id
      - aws_s3_bucket_name
      - aws_secret_access_key
      - integration_balena_api_app_id
      - integration_balena_api_app_secret
      - integration_balena_api_private_key
      - integration_balena_api_public_key_production
      - integration_balena_api_public_key_staging
      - integration_discourse_signature_key
      - integration_discourse_token
      - integration_discourse_username
      - integration_flowdock_signature_key
      - integration_flowdock_token
      - integration_front_token
      - integration_github_app_id
      - integration_github_private_key
      - integration_github_signature_key
      - integration_github_token
      - integration_google_meet_credentials
      - integration_intercom_token
      - integration_outreach_app_id
      - integration_outreach_app_secret
      - integration_outreach_signature_key
      - integration_typeform_signature_key
      - mailgun_token
      - reset_password_secret_token
    restart: always
    networks:
      - internal
    ports:
      - 9232:9229
  balena-mdns-publisher:
    image: 'balena/balena-mdns-publisher:1.10.1'
    network_mode: host
    cap_add:
      - SYS_RESOURCE
      - SYS_ADMIN
    security_opt:
      - 'apparmor=unconfined'
    tmpfs:
      - /run
      - /sys/fs/cgroup
    labels:
      io.balena.features.dbus: '1'
      io.balena.features.supervisor-api: '1'
    environment:
      MDNS_TLD: ly.fish.local
      MDNS_SUBDOMAINS: >-
        ["jel", "livechat", "api", "registry"]
      DBUS_SESSION_BUS_ADDRESS: 'unix:path=/host/run/dbus/system_bus_socket'
      CONFD_BACKEND: 'ENV'
  haproxy:
    image: 'balena/open-balena-haproxy:2.11.3'
    cap_add:
      - SYS_RESOURCE
      - SYS_ADMIN
    security_opt:
      - 'apparmor=unconfined'
    tmpfs:
      - /run
      - /sys/fs/cgroup
    depends_on:
      - worker_1
      - worker_2
      - ui
      - livechat
      - api
      - balena-mdns-publisher
    ports:
      - '80:80'
      - '5432:5432'
      - '6379:6379'
    networks:
      internal:
        aliases:
          - jel.ly.fish.local
          - livechat.ly.fish.local
          - api.ly.fish.local
          - postgres.ly.fish.local
          - redis.ly.fish.local
    environment:
      DOMAIN_INC_UUID: 'false'
      AUTOGENERATE_CERTS: 'false'
      AUTH_TOKEN: <token>
      STATIC_DNS_IP: <ip>
      CONFD_BACKEND: 'ENV'
      PROXY_CONFIG: ewoJImRlZmF1bHRzIjogWwoJCSJ0aW1lb3V0IGNvbm5lY3QgNTAwMCIsCgkJInRpbWVvdXQgY2xpZW50IDYwMDAwIiwKCQkidGltZW91dCBzZXJ2ZXIgNjAwMDAiLAoJCSJkZWZhdWx0LXNlcnZlciBpbml0LWFkZHIgbGFzdCxsaWJjLG5vbmUiCgldLAoJInJlc29sdmVycyI6IFsKCQl7CgkJCSJpZCI6ICJkb2NrZXItYnJpZGdlLXJlc29sdmVyIiwKCQkJIm5hbWVzZXJ2ZXJzIjogewoJCQkJImRvY2tlci1yZXNvbHZlciI6ICIxMjcuMC4wLjExOjUzIgoJCQl9LAoJCQkiaG9sZCI6IHsKCQkJCSJ2YWxpZCI6ICIwbXMiCgkJCX0KCQl9CgldLAoJInVpIjogewoJCSJiYWNrZW5kIjogWwoJCQl7CgkJCQkidXJsIjogImh0dHA6Ly91aTo4MCIsCgkJCQkic2VydmVyIjogewoJCQkJCSJyZXNvbHZlcnMiOiAiZG9ja2VyLWJyaWRnZS1yZXNvbHZlciIsCgkJCQkJInJlc29sdmUtcHJlZmVyIjogImlwdjQiLAoJCQkJCSJjaGVjayI6IG51bGwsCgkJCQkJInBvcnQiOiAiPHBvcnQ+IgoJCQkJfQoJCQl9CgkJXSwKCQkiZnJvbnRlbmQiOiBbCgkJCXsKCQkJCSJwcm90b2NvbCI6ICJodHRwIiwKCQkJCSJkb21haW4iOiAibHkuZmlzaC5sb2NhbCIsCgkJCQkic3ViZG9tYWluIjogImplbCIsCgkJCQkicG9ydCI6ICI4MCIKCQkJfQoJCV0KCX0sCgkicmVkaXMiOiB7CgkJImJhY2tlbmQiOiBbCgkJCXsKCQkJCSJ1cmwiOiAidGNwOi8vcmVkaXM6NjM3OSIsCgkJCQkic2VydmVyIjogewoJCQkJCSJyZXNvbHZlcnMiOiAiZG9ja2VyLWJyaWRnZS1yZXNvbHZlciIsCgkJCQkJInJlc29sdmUtcHJlZmVyIjogImlwdjQiLAoJCQkJCSJjaGVjayI6IG51bGwsCgkJCQkJInBvcnQiOiAiPHBvcnQ+IgoJCQkJfQoJCQl9CgkJXSwKCQkiZnJvbnRlbmQiOiBbCgkJCXsKCQkJCSJwcm90b2NvbCI6ICJ0Y3AiLAoJCQkJImRvbWFpbiI6ICJseS5maXNoLmxvY2FsIiwKCQkJCSJzdWJkb21haW4iOiAicmVkaXMiLAoJCQkJInBvcnQiOiAiNjM3OSIKCQkJfQoJCV0KCX0sCgkicG9zdGdyZXMiOiB7CgkJImJhY2tlbmQiOiBbCgkJCXsKCQkJCSJ1cmwiOiAidGNwOi8vcG9zdGdyZXM6NTQzMiIsCgkJCQkic2VydmVyIjogewoJCQkJCSJyZXNvbHZlcnMiOiAiZG9ja2VyLWJyaWRnZS1yZXNvbHZlciIsCgkJCQkJInJlc29sdmUtcHJlZmVyIjogImlwdjQiLAoJCQkJCSJjaGVjayI6IG51bGwsCgkJCQkJInBvcnQiOiAiPHBvcnQ+IgoJCQkJfQoJCQl9CgkJXSwKCQkiZnJvbnRlbmQiOiBbCgkJCXsKCQkJCSJwcm90b2NvbCI6ICJ0Y3AiLAoJCQkJImRvbWFpbiI6ICJseS5maXNoLmxvY2FsIiwKCQkJCSJzdWJkb21haW4iOiAicG9zdGdyZXMiLAoJCQkJInBvcnQiOiAiNTQzMiIKCQkJfQoJCV0KCX0sCgkibGl2ZWNoYXQiOiB7CgkJImJhY2tlbmQiOiBbCgkJCXsKCQkJCSJ1cmwiOiAiaHR0cDovL2xpdmVjaGF0OjgwIiwKCQkJCSJzZXJ2ZXIiOiB7CgkJCQkJInJlc29sdmVycyI6ICJkb2NrZXItYnJpZGdlLXJlc29sdmVyIiwKCQkJCQkicmVzb2x2ZS1wcmVmZXIiOiAiaXB2NCIsCgkJCQkJImNoZWNrIjogbnVsbCwKCQkJCQkicG9ydCI6ICI8cG9ydD4iCgkJCQl9CgkJCX0KCQldLAoJCSJmcm9udGVuZCI6IFsKCQkJewoJCQkJInByb3RvY29sIjogImh0dHAiLAoJCQkJImRvbWFpbiI6ICJseS5maXNoLmxvY2FsIiwKCQkJCSJzdWJkb21haW4iOiAibGl2ZWNoYXQiLAoJCQkJInBvcnQiOiAiODAiCgkJCX0KCQldCgl9LAoJImFwaSI6IHsKCQkiYmFja2VuZCI6IFsKCQkJewoJCQkJInVybCI6ICJodHRwOi8vYXBpOjgwIiwKCQkJCSJzZXJ2ZXIiOiB7CgkJCQkJInJlc29sdmVycyI6ICJkb2NrZXItYnJpZGdlLXJlc29sdmVyIiwKCQkJCQkicmVzb2x2ZS1wcmVmZXIiOiAiaXB2NCIsCgkJCQkJImNoZWNrIjogbnVsbCwKCQkJCQkicG9ydCI6ICI8cG9ydD4iCgkJCQl9CgkJCX0KCQldLAoJCSJmcm9udGVuZCI6IFsKCQkJewoJCQkJInByb3RvY29sIjogImh0dHAiLAoJCQkJImRvbWFpbiI6ICJseS5maXNoLmxvY2FsIiwKCQkJCSJzdWJkb21haW4iOiAiYXBpIiwKCQkJCSJwb3J0IjogIjgwIgoJCQl9CgkJXQoJfSwKCSJyZWdpc3RyeSI6IHsKCQkiYmFja2VuZCI6IFsKCQkJewoJCQkJInVybCI6ICJodHRwOi8vcmVnaXN0cnk6ODAiLAoJCQkJInNlcnZlciI6IHsKCQkJCQkicmVzb2x2ZXJzIjogImRvY2tlci1icmlkZ2UtcmVzb2x2ZXIiLAoJCQkJCSJyZXNvbHZlLXByZWZlciI6ICJpcHY0IiwKCQkJCQkiY2hlY2siOiBudWxsLAoJCQkJCSJwb3J0IjogIjxwb3J0PiIKCQkJCX0KCQkJfQoJCV0sCgkJImZyb250ZW5kIjogWwoJCQl7CgkJCQkicHJvdG9jb2wiOiAiaHR0cCIsCgkJCQkiZG9tYWluIjogImx5LmZpc2gubG9jYWwiLAoJCQkJInN1YmRvbWFpbiI6ICJyZWdpc3RyeSIsCgkJCQkicG9ydCI6ICI4MCIKCQkJfQoJCV0KCX0KfQoK

networks:
  internal: {}

secrets:
  aws_access_key_id:
    file: ./.balena/secrets/aws_access_key_id.txt
  aws_s3_bucket_name:
    file: ./.balena/secrets/aws_s3_bucket_name.txt
  aws_secret_access_key:
    file: ./.balena/secrets/aws_secret_access_key.txt
  integration_balena_api_app_id:
    file: ./.balena/secrets/integration_balena_api_app_id.txt
  integration_balena_api_app_secret:
    file: ./.balena/secrets/integration_balena_api_app_secret.txt
  integration_balena_api_private_key:
    file: ./.balena/secrets/integration_balena_api_private_key.txt
  integration_balena_api_public_key_production:
    file: ./.balena/secrets/integration_balena_api_public_key_production.txt
  integration_balena_api_public_key_staging:
    file: ./.balena/secrets/integration_balena_api_public_key_staging.txt
  integration_discourse_signature_key:
    file: ./.balena/secrets/integration_discourse_signature_key.txt
  integration_discourse_token:
    file: ./.balena/secrets/integration_discourse_token.txt
  integration_discourse_username:
    file: ./.balena/secrets/integration_discourse_username.txt
  integration_flowdock_signature_key:
    file: ./.balena/secrets/integration_flowdock_signature_key.txt
  integration_flowdock_token:
    file: ./.balena/secrets/integration_flowdock_token.txt
  integration_front_token:
    file: ./.balena/secrets/integration_front_token.txt
  integration_github_app_id:
    file: ./.balena/secrets/integration_github_app_id.txt
  integration_github_private_key:
    file: ./.balena/secrets/integration_github_private_key.txt
  integration_github_signature_key:
    file: ./.balena/secrets/integration_github_signature_key.txt
  integration_github_token:
    file: ./.balena/secrets/integration_github_token.txt
  integration_google_meet_credentials:
    file: ./.balena/secrets/integration_google_meet_credentials.txt
  integration_intercom_token:
    file: ./.balena/secrets/integration_intercom_token.txt
  integration_outreach_app_id:
    file: ./.balena/secrets/integration_outreach_app_id.txt
  integration_outreach_app_secret:
    file: ./.balena/secrets/integration_outreach_app_secret.txt
  integration_outreach_signature_key:
    file: ./.balena/secrets/integration_outreach_signature_key.txt
  integration_typeform_signature_key:
    file: ./.balena/secrets/integration_typeform_signature_key.txt
  mailgun_token:
    file: ./.balena/secrets/mailgun_token.txt
  reset_password_secret_token:
    file: ./.balena/secrets/reset_password_secret_token.txt
  registry_token_auth_cert_key:
    file: ./.balena/secrets/registry_token_auth_cert_key.txt
  registry_token_auth_cert_kid:
    file: ./.balena/secrets/registry_token_auth_cert_kid.txt
