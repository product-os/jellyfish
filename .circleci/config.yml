# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details

aliases:
  workflow_filter: &workflow_filter
      filters:
          branches:
            ignore:
              - /(.*)-build-[a-f0-9]{40}$/
              - master

  job_defaults: &job_defaults
      docker:
        - image: resinci/jellyfish-test

      environment: &job_defaults_environment
        DATABASE: postgres
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres

version: 2
dependencies:
  pre:
jobs:
  build:
    <<: *job_defaults

    steps:
      - checkout

      - run:
          name: Authenticate with registry
          command: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc

      # Restore cached dependencies
      - restore_cache:
          keys:
          - v2-dependencies-{{ checksum "package.json" }}
          # fallback to using the latest cache if no exact match is found
          - v2-dependencies-

      # --unsafe-perm flag allows the postinstall script to run correctly
      - run:
          name: Install Dependencies
          command: PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true npm ci --unsafe-perm

      - save_cache:
          paths:
            - /root/.npm
          key: v2-dependencies-{{ checksum "package.json" }}

      - persist_to_workspace:
          root: .
          paths:
              - node_modules

  sync_tests_github_mirror:
    <<: *job_defaults

    resource_class: xlarge

    steps:
      - checkout

      - run:
          name: Authenticate with registry
          command: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc

      - attach_workspace:
          at: .

      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Install scripts-template dependencies
          command: cd scripts/template && npm install
      - run:
          name: Compose Build
          command: make compose-build SIDECAR=1
      - run:
          name: Compose Up
          command: make compose-up SIDECAR=1 DETACH=1 INTEGRATION_GITHUB_TOKEN=$GITHUB_TOKEN INTEGRATION_GITHUB_SIGNATURE_KEY=$GITHUB_SIGNATURE_KEY INTEGRATION_GITHUB_PRIVATE_KEY=$GITHUB_PRIVATE_KEY INTEGRATION_GITHUB_APP_ID=$GITHUB_APP_ID
      - run:
          name: Sync Tests
          command: make docker-exec-jellyfish_sidecar_1 COMMAND="make" ARGS="test FILES=./test/e2e/sync/github-mirror.spec.js SCRUB=0 INTEGRATION_GITHUB_TOKEN=$GITHUB_TOKEN INTEGRATION_GITHUB_SIGNATURE_KEY=$GITHUB_SIGNATURE_KEY INTEGRATION_GITHUB_PRIVATE_KEY=$GITHUB_PRIVATE_KEY INTEGRATION_GITHUB_APP_ID=$GITHUB_APP_ID AVA_OPTS='-T 10m'"
      - run:
          name: Compose Down
          command: make compose-stop

  sync_tests_front_mirror:
    <<: *job_defaults

    resource_class: xlarge

    steps:
      - checkout

      - run:
          name: Authenticate with registry
          command: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc

      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Install scripts-template dependencies
          command: cd scripts/template && npm install
      - run:
          name: Compose Build
          command: make compose-build SIDECAR=1
      - run:
          name: Compose Up
          command: make compose-up SIDECAR=1 DETACH=1 INTEGRATION_FRONT_TOKEN=$FRONT_TOKEN INTEGRATION_INTERCOM_TOKEN=$INTERCOM_TOKEN
      - run:
          name: Sync Tests
          command: make docker-exec-jellyfish_sidecar_1 COMMAND="make" ARGS="test FILES=./test/e2e/sync/front-mirror.spec.js SCRUB=0 INTEGRATION_FRONT_TOKEN=$FRONT_TOKEN INTEGRATION_INTERCOM_TOKEN=$INTERCOM_TOKEN AVA_OPTS='-T 10m'"
      - run:
          name: Compose Down
          command: make compose-stop

  sync_tests_discourse_mirror:
    <<: *job_defaults

    resource_class: xlarge

    steps:
      - checkout

      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Install scripts-template dependencies
          command: cd scripts/template && npm install
      - run:
          name: Compose Build
          command: make compose-build SIDECAR=1
      - run:
          name: Compose Up
          command: make compose-up SIDECAR=1 DETACH=1 INTEGRATION_DISCOURSE_TOKEN=$DISCOURSE_TOKEN INTEGRATION_DISCOURSE_SIGNATURE_KEY=$DISCOURSE_SIGNATURE_KEY INTEGRATION_DISCOURSE_USERNAME=$DISCOURSE_USERNAME
      - run:
          name: Sync Tests
          command: make docker-exec-jellyfish_sidecar_1 COMMAND="make" ARGS="test FILES=./test/e2e/sync/discourse-mirror.spec.js SCRUB=0 INTEGRATION_DISCOURSE_TOKEN=$DISCOURSE_TOKEN INTEGRATION_DISCOURSE_SIGNATURE_KEY=$DISCOURSE_SIGNATURE_KEY INTEGRATION_DISCOURSE_USERNAME=$DISCOURSE_USERNAME AVA_OPTS='-T 10m'"
      - run:
          name: Compose Down
          command: make compose-stop

  e2e_tests_server: &e2e_tests_server
    <<: *job_defaults

    resource_class: xlarge

    steps:
      - checkout

      - run:
          name: Authenticate with registry
          command: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc

      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Install scripts-template dependencies
          command: cd scripts/template && npm install
      - run:
          name: Compose Build
          command: make compose-build SIDECAR=1
      - run:
          name: Docker Compose Up
          command: make compose-up SIDECAR=1 DETACH=1 INTEGRATION_GITHUB_TOKEN=$GITHUB_TOKEN INTEGRATION_GITHUB_SIGNATURE_KEY=$GITHUB_SIGNATURE_KEY INTEGRATION_OUTREACH_APP_ID=$OUTREACH_APP_ID INTEGRATION_OUTREACH_APP_SECRET=$OUTREACH_APP_SECRET INTEGRATION_OUTREACH_SIGNATURE_KEY=$OUTREACH_SIGNATURE_KEY INTEGRATION_FLOWDOCK_SIGNATURE_KEY=$FLOWDOCK_SIGNATURE_KEY INTEGRATION_TYPEFORM_SIGNATURE_KEY=$TYPEFORM_SIGNATURE_KEY OAUTH_REDIRECT_BASE_URL=https://jel.ly.fish
      - run:
          name: End To End Tests (Server)
          command: make docker-exec-jellyfish_sidecar_1 COMMAND="make" ARGS="test-e2e-server SCRUB=0 INTEGRATION_GITHUB_TOKEN=$GITHUB_TOKEN INTEGRATION_GITHUB_SIGNATURE_KEY=$GITHUB_SIGNATURE_KEY INTEGRATION_OUTREACH_APP_ID=$OUTREACH_APP_ID INTEGRATION_OUTREACH_APP_SECRET=$OUTREACH_APP_SECRET INTEGRATION_OUTREACH_SIGNATURE_KEY=$OUTREACH_SIGNATURE_KEY INTEGRATION_FLOWDOCK_SIGNATURE_KEY=$FLOWDOCK_SIGNATURE_KEY INTEGRATION_TYPEFORM_SIGNATURE_KEY=$TYPEFORM_SIGNATURE_KEY OAUTH_REDIRECT_BASE_URL=https://jel.ly.fish"
      - run:
          name: Postgres Dump
          command: docker exec jellyfish_postgres_1 bash -c 'PGPASSWORD="${POSTGRES_PASSWORD}" pg_dump --username="${POSTGRES_USER}" jellyfish' | gzip -9 > dump-server.gz
      - run:
          name: Docker Compose Down
          command: make compose-stop

      - persist_to_workspace:
          root: .
          paths:
            - dump-server.gz

  e2e_tests_server_previous_dump: &e2e_tests_server_previous_dump
    <<: *job_defaults

    resource_class: xlarge

    steps:
      - checkout

      - run:
          name: Authenticate with registry
          command: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc

      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Install scripts-template dependencies
          command: cd scripts/template && npm install
      - run:
          name: Compose Build
          command: make compose-build SIDECAR=1
      - run:
          name: Docker Compose Up
          command: make compose-up SIDECAR=1 DETACH=1 INTEGRATION_GITHUB_TOKEN=$GITHUB_TOKEN INTEGRATION_GITHUB_SIGNATURE_KEY=$GITHUB_SIGNATURE_KEY INTEGRATION_OUTREACH_APP_ID=$OUTREACH_APP_ID INTEGRATION_OUTREACH_APP_SECRET=$OUTREACH_APP_SECRET INTEGRATION_OUTREACH_SIGNATURE_KEY=$OUTREACH_SIGNATURE_KEY INTEGRATION_FLOWDOCK_SIGNATURE_KEY=$FLOWDOCK_SIGNATURE_KEY OAUTH_REDIRECT_BASE_URL=https://jel.ly.fish
      - run:
          name: Fetch Old Postgres Dump
          command: ./scripts/ci/postgres-get-previous-dump.sh server && ls -l && gunzip dump.gz
      - run:
          name: Import Postgres Dump
          command: docker cp dump jellyfish_sidecar_1:/usr/src/jellyfish/dump && make docker-exec-jellyfish_sidecar_1 COMMAND="./scripts/ci/postgres-import-snapshot.sh" ARGS="/usr/src/jellyfish/dump"
      - run:
          name: End To End Tests (Server)
          command: make docker-exec-jellyfish_sidecar_1 COMMAND="make" ARGS="test-e2e-server SCRUB=0 INTEGRATION_GITHUB_TOKEN=$GITHUB_TOKEN INTEGRATION_GITHUB_SIGNATURE_KEY=$GITHUB_SIGNATURE_KEY INTEGRATION_OUTREACH_APP_ID=$OUTREACH_APP_ID INTEGRATION_OUTREACH_APP_SECRET=$OUTREACH_APP_SECRET INTEGRATION_OUTREACH_SIGNATURE_KEY=$OUTREACH_SIGNATURE_KEY INTEGRATION_FLOWDOCK_SIGNATURE_KEY=$FLOWDOCK_SIGNATURE_KEY OAUTH_REDIRECT_BASE_URL=https://jel.ly.fish"
      - run:
          name: Docker Compose Down
          command: make compose-stop

  results:
    <<: *job_defaults

    steps:
      - checkout

      - run:
          name: Authenticate with registry
          command: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc

      - attach_workspace:
          at: .

      - run:
          name: Install Dependencies
          command: npm i
      - run:
          name: Postgres Dump
          command: mkdir -p /tmp/test-results && cp dump-*.gz /tmp/test-results/

      # Store artifacts for debugging purposes
      - store_test_results:
          path: /tmp/test-results
      - store_artifacts:
          path: /tmp/test-results
          destination: test-results

      - run:
          name: Generate Summary
          command: ./scripts/ci/summary.sh > SUMMARY

      - run:
          name: Post PR Summary
          command: GITHUB_TOKEN=$GITHUB_TOKEN node scripts/ci/github-pr-summary.js $CIRCLE_PULL_REQUEST ./SUMMARY

workflows:
    version: 2
    build:
        jobs:
            - build:
                <<: *workflow_filter

            - e2e_tests_server:
                requires:
                  - build
                <<: *workflow_filter

            - e2e_tests_server_previous_dump:
                requires:
                  - build
                <<: *workflow_filter

            - sync_tests_front_mirror:
                requires:
                  - build
                <<: *workflow_filter

            - sync_tests_discourse_mirror:
                requires:
                  - build
                <<: *workflow_filter

            - sync_tests_github_mirror:
                requires:
                  - build
                <<: *workflow_filter

            - results:
                requires:
                  - e2e_tests_server
                  - e2e_tests_server_previous_dump
                  - sync_tests_front_mirror
                  - sync_tests_discourse_mirror
                  - sync_tests_github_mirror
                <<: *workflow_filter
