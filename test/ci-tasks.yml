tickTimeout: 5
retryTimeout: 120
attemptsDefault: 3
environment:
  - name: 'AVA_OPTS'
    value: '--fail-fast'
tasks:
  - name: 'wait-for-api'
    description: 'Wait for API to be available'
    command: '/usr/src/jellyfish/scripts/ci/wait-for-api.sh'
    cwd: '/usr/src/jellyfish'
    required: true
    attempts: 1
  - name: 'clean-github'
    description: 'GitHub Test Data Cleanup'
    command: 'make clean-github'
    cwd: '/usr/src/jellyfish'
    required: false
    attempts: 1
  - name: 'clean-front'
    description: 'Front Test Data Cleanup'
    command: 'make clean-front'
    cwd: '/usr/src/jellyfish'
    required: false
    attempts: 1
    dependencies:
      - 'clean-github'
      - 'front-mirror'
  - name: 'pipeline-sync'
    description: 'Pipeline Sync Tests'
    command: 'make test'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'FILES'
        value: './test/integration/sync/pipeline.spec.js'
    dependencies:
      - 'wait-for-api'
  - name: 'front-mirror'
    description: 'Front Mirror Tests'
    command: 'make test'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'FILES'
        value: './test/e2e/sync/front-mirror.spec.js'
    dependencies:
      - 'pipeline-sync'
  - name: 'discourse-mirror'
    description: 'Discourse Mirror Tests'
    command: 'make test'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'FILES'
        value: './test/e2e/sync/discourse-mirror.spec.js'
    dependencies:
      - 'front-mirror'
  - name: 'github-mirror'
    description: 'GitHub Mirror Tests'
    command: 'make test'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'FILES'
        value: './test/e2e/sync/github-mirror.spec.js'
    dependencies:
      - 'discourse-mirror'
  - name: 'e2e-livechat'
    description: 'E2E Livechat Tests'
    command: 'make test-e2e-livechat'
    cwd: '/usr/src/jellyfish'
    required: true
    dependencies:
      - 'front-mirror'
  - name: 'e2e-ui'
    description: 'E2E UI Tests'
    command: 'make test-e2e-ui'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'INTEGRATION_OUTREACH_APP_ID'
        value: ''
    dependencies:
      - 'e2e-livechat'
  - name: 'balena-api-translate'
    description: 'Balena API Translate Tests'
    command: './scripts/ci/skip_tests_if_only.sh ui livechat || make test'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'CHECK_FOR'
        value: 'balena-api-translate.spec.js'
      - name: 'FILES'
        value: './test/integration/sync/balena-api-translate.spec.js'
    dependencies:
      - 'e2e-ui'
      - 'front-mirror'
  - name: 'github-translate'
    description: 'GitHub Translate Tests'
    command: './scripts/ci/skip_tests_if_only.sh ui livechat || make test'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'CHECK_FOR'
        value: 'github-translate.spec.js'
      - name: 'FILES'
        value: './test/integration/sync/github-translate.spec.js'
      - name: 'INTEGRATION_GITHUB_APP_ID'
        value: ''
    dependencies:
      - 'balena-api-translate'
  - name: 'flowdock-translate'
    description: 'Flowdock Translate Tests'
    command: './scripts/ci/skip_tests_if_only.sh ui livechat || make test'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'CHECK_FOR'
        value: 'flowdock-translate.spec.js'
      - name: 'FILES'
        value: './test/integration/sync/flowdock-translate.spec.js'
    dependencies:
      - 'github-translate'
  - name: 'typeform-translate'
    description: 'Typeform Translate Tests'
    command: './scripts/ci/skip_tests_if_only.sh ui livechat || make test'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'CHECK_FOR'
        value: 'typeform-translate.spec.js'
      - name: 'FILES'
        value: './test/integration/sync/typeform-translate.spec.js'
    dependencies:
      - 'flowdock-translate'
  - name: 'outreach-translate'
    description: 'Outreach Translate Tests'
    command: './scripts/ci/skip_tests_if_only.sh ui livechat || make test'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'CHECK_FOR'
        value: 'outreach-translate.spec.js'
      - name: 'FILES'
        value: './test/integration/sync/outreach-translate.spec.js'
    dependencies:
      - 'typeform-translate'
  - name: 'integration-server'
    description: 'Server Integration Tests'
    command: 'make test-integration-server'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'SERVER_HOST'
        value: 'http://localhost'
    dependencies:
      - 'front-mirror'
  - name: 'integration-worker'
    description: 'Worker Integration Tests'
    command: 'make test-integration-worker'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'MAILGUN_TOKEN'
        value: ''
    dependencies:
      - 'integration-server'
  - name: 'front-translate'
    description: 'Front Translate Tests'
    command: './scripts/ci/skip_tests_if_only.sh ui livechat || make test'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'CHECK_FOR'
        value: 'front-translate.spec.js'
      - name: 'FILES'
        value: './test/integration/sync/front-translate.spec.js'
      - name: 'INTEGRATION_FRONT_TOKEN'
        value: 'foobar'
    dependencies:
      - 'outreach-translate'
      - 'integration-worker'
  - name: 'discourse-translate'
    description: 'Discourse Translate Tests'
    command: './scripts/ci/skip_tests_if_only.sh ui livechat || make test'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'CHECK_FOR'
        value: 'discourse-translate.spec.js'
      - name: 'FILES'
        value: './test/integration/sync/discourse-translate.spec.js'
    dependencies:
      - 'typeform-translate'
      - 'integration-worker'
  - name: 'e2e-server'
    description: 'E2E Server Tests'
    command: 'make test-e2e-server'
    cwd: '/usr/src/jellyfish'
    required: true
    dependencies:
      - 'e2e-ui'
  - name: 'postgres-export'
    description: 'Export Postgres dump'
    command: './scripts/ci/postgres/export.js e2e-server'
    cwd: '/usr/src/jellyfish'
    required: true
    dependencies:
      - 'e2e-server'
  - name: 'postgres-import'
    description: 'Import Postgres dump from most recently merged commit'
    command: './scripts/ci/postgres/import.js e2e-server'
    cwd: '/usr/src/jellyfish'
    required: true
    dependencies:
      - 'front-translate'
      - 'discourse-translate'
      - 'postgres-export'
  - name: 'e2e-server-previous-dump'
    description: 'E2E Server Tests (Previous Dump)'
    command: 'make test-e2e-server'
    cwd: '/usr/src/jellyfish'
    required: true
    dependencies:
      - 'postgres-import'
  - name: 'summary'
    description: 'Post Summary to GitHub'
    command: './scripts/ci/summary.js'
    cwd: '/usr/src/jellyfish'
    required: false
    dependencies:
      - 'e2e-server-previous-dump'
