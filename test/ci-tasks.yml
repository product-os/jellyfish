tickTimeout: 5
retryTimeout: 120
attemptsDefault: 3
environment:
  - name: 'AVA_OPTS'
    value: '--fail-fast'
tasks:
  - name: 'wait-for-api'
    description: 'Wait for API to be available'
    command: '/usr/src/jellyfish/scripts/ci/wait-for-api.sh'
    cwd: '/usr/src/jellyfish'
    required: true
    attempts: 1
  - name: 'clean-github'
    description: 'GitHub Test Data Cleanup'
    command: 'make clean-github'
    cwd: '/usr/src/jellyfish'
    required: false
    attempts: 1
  - name: 'clean-front'
    description: 'Front Test Data Cleanup'
    command: 'make clean-front'
    cwd: '/usr/src/jellyfish'
    required: false
    attempts: 1
    dependencies:
      - 'clean-github'
      - 'front-mirror'
  - name: 'front-mirror'
    description: 'Front Mirror Tests'
    command: 'make test'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'FILES'
        value: './test/e2e/sync/front-mirror.spec.js'
  - name: 'discourse-mirror'
    description: 'Discourse Mirror Tests'
    command: 'make test'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'FILES'
        value: './test/e2e/sync/discourse-mirror.spec.js'
    dependencies:
      - 'front-mirror'
  - name: 'github-mirror'
    description: 'GitHub Mirror Tests'
    command: 'make test'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'FILES'
        value: './test/e2e/sync/github-mirror.spec.js'
    dependencies:
      - 'discourse-mirror'
  - name: 'e2e-livechat'
    description: 'E2E Livechat Tests'
    command: 'make test-e2e-livechat'
    cwd: '/usr/src/jellyfish'
    required: true
    dependencies:
      - 'front-mirror'
  - name: 'e2e-ui'
    description: 'E2E UI Tests'
    command: 'make test-e2e-ui'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'INTEGRATION_OUTREACH_APP_ID'
        value: ''
    dependencies:
      - 'e2e-livechat'
  - name: 'integration-server'
    description: 'Server Integration Tests'
    command: 'make test-integration-server'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'SERVER_HOST'
        value: 'http://localhost'
    dependencies:
      - 'front-mirror'
  - name: 'integration-worker'
    description: 'Worker Integration Tests'
    command: 'make test-integration-worker'
    cwd: '/usr/src/jellyfish'
    required: true
    environment:
      - name: 'MAILGUN_TOKEN'
        value: ''
    dependencies:
      - 'integration-server'
  - name: 'e2e-server'
    description: 'E2E Server Tests'
    command: 'make test-e2e-server'
    cwd: '/usr/src/jellyfish'
    required: true
    dependencies:
      - 'e2e-ui'
  - name: 'postgres-export'
    description: 'Export Postgres dump'
    command: './scripts/ci/postgres/export.js e2e-server'
    cwd: '/usr/src/jellyfish'
    required: true
    dependencies:
      - 'e2e-server'
  - name: 'postgres-import'
    description: 'Import Postgres dump from most recently merged commit'
    command: './scripts/ci/postgres/import.js e2e-server'
    cwd: '/usr/src/jellyfish'
    required: true
    dependencies:
      - 'postgres-export'
  - name: 'e2e-server-previous-dump'
    description: 'E2E Server Tests (Previous Dump)'
    command: 'make test-e2e-server'
    cwd: '/usr/src/jellyfish'
    required: true
    dependencies:
      - 'postgres-import'
  - name: 'summary'
    description: 'Post Summary to GitHub'
    command: './scripts/ci/summary.js'
    cwd: '/usr/src/jellyfish'
    required: false
    dependencies:
      - 'e2e-server-previous-dump'
