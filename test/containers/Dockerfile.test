FROM resinci/jellyfish-test:1.3.31

WORKDIR /usr/src/jellyfish
ARG NPM_TOKEN

# Install npm packages, --unsafe-perm flag allows the postinstall script to run correctly
COPY . ./
RUN echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc && \
	PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true npm ci --unsafe-perm && \
	cd /usr/src/jellyfish/apps/server && npm ci && \
	cd /usr/src/jellyfish/apps/action-server && npm ci && \
	cd /usr/src/jellyfish/apps/livechat && PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true npm ci && \
	cd /usr/src/jellyfish/apps/ui && npm ci && \
	rm -f ~/.npmrc

# Copy in source and run catch-uncommitted, lint, and unit tests
RUN make docs/assets/architecture.png ARCHITECTURE.md docker-compose.yml && \
	npx catch-uncommitted --skip-node-versionbot-changes --exclude=VERSION,.versionbot/ && \
	make lint && \
	make test-unit COVERAGE=0
