version: '2.1'

services:
  verdaccio:
    build:
      context: .
      dockerfile: Dockerfile.verdaccio
    expose:
      - 4873
    ports:
      - '4873:4873'
    networks:
      - internal
    environment:
      - NPM_TOKEN
  api:
    build:
      context: .
      dockerfile: apps/server/Dockerfile
      args:
        - NPM_TOKEN
    networks:
      - internal
    depends_on:
      - verdaccio
      - postgres
      - redis
      - tick
      {{#workers}}
      - worker_{{idx}}
      {{/workers}}
      - balena-mdns-publisher
    environment:
      - DATABASE={{DATABASE}}
      - LOGENTRIES_TOKEN
      - LOGLEVEL
      - NODE_ENV
      - POD_NAME={{POD_NAME}}
      - PORT={{PORT}}
      - POSTGRES_DATABASE={{POSTGRES_DATABASE}}
      - POSTGRES_HOST=postgres
      - POSTGRES_PASSWORD=docker
      - POSTGRES_PORT={{POSTGRES_PORT}}
      - POSTGRES_USER=docker
      - REDIS_HOST=redis
      - REDIS_PASSWORD=
      - REDIS_PORT={{REDIS_PORT}}
      - SENTRY_DSN_SERVER
      - SERVER_DATABASE={{SERVER_DATABASE}}
      - SERVER_HOST=http://localhost
      - SERVER_PORT=8000
      - TEST_USER_ORGANIZATION={{TEST_USER_ORGANIZATION}}
      - TEST_USER_PASSWORD={{TEST_USER_PASSWORD}}
      - TEST_USER_ROLE={{TEST_USER_ROLE}}
      - TEST_USER_USERNAME={{TEST_USER_USERNAME}}
      - FS_DRIVER
      - AWS_ACCESS_KEY_ID
      - AWS_S3_BUCKET_NAME
      - AWS_SECRET_ACCESS_KEY
      - INTEGRATION_BALENA_API_APP_SECRET=foobar
      - INTEGRATION_BALENA_API_OAUTH_BASE_URL=https://api.balena-cloud.com
      - INTEGRATION_BALENA_API_PRIVATE_KEY
      - INTEGRATION_BALENA_API_PUBLIC_KEY_PRODUCTION
      - INTEGRATION_BALENA_API_PUBLIC_KEY_STAGING=foobar
      - INTEGRATION_DEFAULT_USER
      - INTEGRATION_DISCOURSE_SIGNATURE_KEY
      - INTEGRATION_DISCOURSE_TOKEN
      - INTEGRATION_DISCOURSE_USERNAME
      - INTEGRATION_FLOWDOCK_SIGNATURE_KEY
      - INTEGRATION_FLOWDOCK_TOKEN
      - INTEGRATION_FRONT_TOKEN
      - INTEGRATION_GITHUB_APP_ID
      - INTEGRATION_GITHUB_PRIVATE_KEY
      - INTEGRATION_GITHUB_SIGNATURE_KEY
      - INTEGRATION_GITHUB_TOKEN
      - INTEGRATION_GOOGLE_MEET_CREDENTIALS="{}"
      - INTEGRATION_INTERCOM_TOKEN
      - INTEGRATION_OUTREACH_APP_ID
      - INTEGRATION_OUTREACH_APP_SECRET
      - INTEGRATION_OUTREACH_SIGNATURE_KEY
      - INTEGRATION_TYPEFORM_SIGNATURE_KEY
      - MAILGUN_DOMAIN
      - MAILGUN_BASE_URL
      - MAILGUN_TOKEN
      - MONITOR_SECRET_TOKEN
      - NPM_TOKEN
      - RESET_PASSWORD_SECRET_TOKEN
      - CI
      - NPM_CONFIG_REGISTRY
    expose:
      - 80
    restart: always
  livechat:
    build:
      context: .
      dockerfile: apps/livechat/Dockerfile
      args:
        - NPM_TOKEN
    depends_on:
      - verdaccio
      - api
      - balena-mdns-publisher
    networks:
      - internal
    environment:
      - NGINX_PORT=80
      - SERVER_HOST=http://api
      - SERVER_PORT=8000
      - NODE_ENV
      - CI
      - NPM_CONFIG_REGISTRY
  postgres:
    image: balena/open-balena-db:4.1.0
    restart: always
    networks:
      - internal
  redis:
    image: balena/balena-redis:0.0.3
    command: [sh, -c, "redis-server /usr/local/etc/redis/redis.conf --save ''"]
    restart: always
    networks:
      - internal
  tick:
    build:
      context: .
      dockerfile: apps/action-server/Dockerfile.tick
      args:
        - NPM_TOKEN
    depends_on:
      - verdaccio
      - postgres
      - redis
      - balena-mdns-publisher
    environment:
      - DATABASE={{DATABASE}}
      - LOGENTRIES_TOKEN
      - NODE_ENV
      - POSTGRES_DATABASE={{POSTGRES_DATABASE}}
      - POSTGRES_HOST=postgres
      - POSTGRES_PASSWORD=docker
      - POSTGRES_PORT={{POSTGRES_PORT}}
      - POSTGRES_USER=docker
      - REDIS_HOST=redis
      - REDIS_PASSWORD=
      - REDIS_PORT={{REDIS_PORT}}
      - LOGLEVEL
      - SENTRY_DSN_SERVER
      - CI
      - NPM_CONFIG_REGISTRY
    restart: always
    networks:
      - internal
  ui:
    build:
      context: .
      dockerfile: apps/ui/Dockerfile
      args:
        - NPM_TOKEN
    depends_on:
      - verdaccio
      - api
      - balena-mdns-publisher
    environment:
      - NGINX_PORT=80
      - SENTRY_DSN_UI=0
      - NODE_ENV
      - SERVER_HOST=http://api.ly.fish.local
      - SERVER_PORT=80
      - CI
      - NPM_CONFIG_REGISTRY
    expose:
      - 80
    networks:
      - internal
  {{#workers}}
  worker_{{idx}}:
    build:
      context: .
      dockerfile: apps/action-server/Dockerfile.worker
      args:
        - NPM_TOKEN
    depends_on:
      - verdaccio
      - postgres
      - redis
      - balena-mdns-publisher
    environment:
      - DATABASE={{DATABASE}}
      - LOGLEVEL
      - NODE_ENV
      - POSTGRES_DATABASE={{POSTGRES_DATABASE}}
      - POSTGRES_HOST=postgres
      - POSTGRES_PASSWORD=docker
      - POSTGRES_PORT={{POSTGRES_PORT}}
      - POSTGRES_USER=docker
      - REDIS_HOST=redis
      - REDIS_PASSWORD=
      - REDIS_PORT={{REDIS_PORT}}
      - SENTRY_DSN_SERVER
      - LOGENTRIES_TOKEN
      - FS_DRIVER
      - AWS_ACCESS_KEY_ID
      - AWS_S3_BUCKET_NAME
      - AWS_SECRET_ACCESS_KEY
      - INTEGRATION_BALENA_API_APP_SECRET=foobar
      - INTEGRATION_BALENA_API_OAUTH_BASE_URL=https://api.balena-cloud.com
      - INTEGRATION_BALENA_API_PRIVATE_KEY
      - INTEGRATION_BALENA_API_PUBLIC_KEY_PRODUCTION
      - INTEGRATION_BALENA_API_PUBLIC_KEY_STAGING=foobar
      - INTEGRATION_DEFAULT_USER
      - INTEGRATION_DISCOURSE_SIGNATURE_KEY
      - INTEGRATION_DISCOURSE_TOKEN
      - INTEGRATION_DISCOURSE_USERNAME
      - INTEGRATION_FLOWDOCK_SIGNATURE_KEY
      - INTEGRATION_FLOWDOCK_TOKEN
      - INTEGRATION_FRONT_TOKEN
      - INTEGRATION_GITHUB_APP_ID
      - INTEGRATION_GITHUB_PRIVATE_KEY
      - INTEGRATION_GITHUB_SIGNATURE_KEY
      - INTEGRATION_GITHUB_TOKEN
      - INTEGRATION_GOOGLE_MEET_CREDENTIALS="{}"
      - INTEGRATION_INTERCOM_TOKEN
      - INTEGRATION_OUTREACH_APP_ID
      - INTEGRATION_OUTREACH_APP_SECRET
      - INTEGRATION_OUTREACH_SIGNATURE_KEY
      - INTEGRATION_TYPEFORM_SIGNATURE_KEY
      - MAILGUN_DOMAIN
      - MAILGUN_BASE_URL
      - MAILGUN_TOKEN
      - MONITOR_SECRET_TOKEN
      - NPM_TOKEN
      - RESET_PASSWORD_SECRET_TOKEN
      - CI
      - NPM_CONFIG_REGISTRY
    restart: always
    networks:
      - internal
  {{/workers}}
  sidecar:
    build:
      context: .
      dockerfile: apps/sidecar/Dockerfile
      args:
        - NPM_TOKEN
    depends_on:
      - verdaccio
      - api
      - livechat
      - postgres
      - ui
      - balena-mdns-publisher
    environment:
      - DATABASE={{DATABASE}}
      - LOGLEVEL
      - LIVECHAT_HOST=http://livechat
      - LIVECHAT_PORT=80
      - NODE_ENV
      - POSTGRES_DATABASE={{POSTGRES_DATABASE}}
      - POSTGRES_HOST=postgres
      - POSTGRES_PASSWORD=docker
      - POSTGRES_USER=docker
      - SERVER_HOST=http://api
      - SERVER_PORT=8000
      - UI_HOST=http://ui
      - UI_PORT=80
      - REDIS_HOST=redis
      - REDIS_PASSWORD=
      - REDIS_PORT={{REDIS_PORT}}
      - SCRUB=0
      - COVERAGE=0
      - FS_DRIVER
      - AWS_ACCESS_KEY_ID
      - AWS_S3_BUCKET_NAME
      - AWS_SECRET_ACCESS_KEY
      - INTEGRATION_BALENA_API_OAUTH_BASE_URL
      - INTEGRATION_BALENA_API_PRIVATE_KEY
      - INTEGRATION_BALENA_API_PUBLIC_KEY_PRODUCTION
      - INTEGRATION_BALENA_API_PUBLIC_KEY_STAGING
      - INTEGRATION_DEFAULT_USER
      - INTEGRATION_DISCOURSE_SIGNATURE_KEY
      - INTEGRATION_DISCOURSE_TOKEN
      - INTEGRATION_DISCOURSE_USERNAME
      - INTEGRATION_FLOWDOCK_SIGNATURE_KEY
      - INTEGRATION_FLOWDOCK_TOKEN
      - INTEGRATION_FRONT_TOKEN
      - INTEGRATION_GITHUB_APP_ID=
      - INTEGRATION_GITHUB_PRIVATE_KEY
      - INTEGRATION_GITHUB_SIGNATURE_KEY
      - INTEGRATION_GITHUB_TOKEN
      - INTEGRATION_GOOGLE_MEET_CREDENTIALS="{}"
      - INTEGRATION_INTERCOM_TOKEN
      - INTEGRATION_OUTREACH_APP_ID
      - INTEGRATION_OUTREACH_APP_SECRET
      - INTEGRATION_OUTREACH_SIGNATURE_KEY
      - INTEGRATION_TYPEFORM_SIGNATURE_KEY
      - MAILGUN_BASE_URL=https://api.mailgun.net/v3
      - MAILGUN_DOMAIN=mail.ly.fish
      - MAILGUN_TOKEN
      - MONITOR_SECRET_TOKEN
      - NPM_TOKEN
      - RESET_PASSWORD_SECRET_TOKEN=foobar
      - OAUTH_REDIRECT_BASE_URL=https://jel.ly.fish
      - NPM_CONFIG_REGISTRY
    networks:
      - internal
  balena-mdns-publisher:
    image: 'balena/balena-mdns-publisher:v1.7.9'
    network_mode: host
    cap_add:
      - SYS_RESOURCE
      - SYS_ADMIN
    security_opt:
      - 'apparmor:unconfined'
    tmpfs:
      - /run
      - /sys/fs/cgroup
    labels:
      io.balena.features.dbus: '1'
      io.balena.features.supervisor-api: '1'
    environment:
      MDNS_TLD: ly.fish.local
      MDNS_SUBDOMAINS: >-
        ["jel", "livechat", "api"]
      DBUS_SESSION_BUS_ADDRESS: 'unix:path=/host/run/dbus/system_bus_socket'
      CONFD_BACKEND: 'ENV'
  haproxy:
    image: 'balena/open-balena-haproxy:3.0.7'
    cap_add:
      - SYS_RESOURCE
      - SYS_ADMIN
    security_opt:
      - 'apparmor:unconfined'
    tmpfs:
      - /run
      - /sys/fs/cgroup
    depends_on:
      - verdaccio
      {{#workers}}
      - worker_{{idx}}
      {{/workers}}
      - ui
      - tick
      - livechat
      - api
      - balena-mdns-publisher
    ports:
      - '80:80'
      - '{{POSTGRES_PORT}}:{{POSTGRES_PORT}}'
      - '{{REDIS_PORT}}:{{REDIS_PORT}}'
    networks:
      internal:
        aliases:
          - jel.ly.fish.local
          - livechat.ly.fish.local
          - api.ly.fish.local
    environment:
      DOMAIN_INC_UUID: 'false'
      AUTOGENERATE_CERTS: 'false'
      AUTH_TOKEN: <token>
      STATIC_DNS_IP: <ip>
      CONFD_BACKEND: 'ENV'
      PROXY_CONFIG: {{& HAPROXY_CONFIG}}

networks:
  internal: {}
